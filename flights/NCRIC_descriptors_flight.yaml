# "SELECT \"d\".*, \"b\".\"red_vrm\" as \"red_vrm\", \"b\".\"red_id\" as \"red_id\" FROM boss3_21_descriptors as \"d\" LEFT JOIN boss3data21_aug2018_top200k as \"b\" ON (\"b\".\"red_vrm\"=\"d\".\"Plate\") AND (\"TimeStamp\"=\"date\") WHERE \"TimeStamp\" >= '2018-08-01' AND \"TimeStamp\" <='2018-09-01' AND \"red_id\" is not null AND \"red_vrm\"<>'CAUTION'"



#not using confidencemetrics (LabelConfidence in Descriptors view dataset) so then 2 entities and 1 association.

entityDefinitions:
  vehicles:
    fqn: "ol.vehicle"
    entitySetName: "NCRICVehicles"
    propertyDefinitions:
      ol.id:
        type: "ol.id"
        column: "Plate"
      vehicle.licensenumber:
        type: "vehicle.licensenumber"
        column: "Plate"
    name: "vehicles"

  vehiclerecords:
    fqn: "ol.vehicle"
    entitySetName: "NCRICVehicleRecords"
    propertyDefinitions:
      ol.id:
        type: "ol.id" 
        # changed from Plate to red_id to match BOSS3 flight code. 
        column: "red_id"
      vehicle.licensenumber:
        type: "vehicle.licensenumber"
        column: "Plate"
      ol.datelogged:
        type: "ol.datelogged"
        column: "TimeStamp"
        transforms:
        - !<transforms.DateTimeTransform>
          pattern: ["yyyy-MM-dd HH:mm:ss.S","yyyy-MM-dd HH:mm:ss.SS","yyyy-MM-dd HH:mm:ss.SSS"]
      vehicle.make:
        type: "vehicle.make"
        transforms:
        - !<transforms.BooleanRegexTransform>
          column: "LabelName"
          pattern: "(?i)(acura|audi|bmw|buick|cadillac|chevy|chrysler|dodge|fiat|ford|gmc|honda|hyundai|infinity|jeep|kia|lexus|lincoln|mazda|mercedes|mercury|mini|mitsubishi|nissan|pontiac|scion|subaru|suzuki|tesla|toyota|volvo|vw)"
          transformsIfTrue:
          - !<transforms.ColumnTransform>
            column: "LabelName"
          # transformsIfFalse:
          #   value: null
      vehicle.model:
        type: "vehicle.model"
        transforms:
        - !<transforms.BooleanRegexTransform>
          column: "LabelName"
          pattern: "(?i)(ford-mustang-gt|ford-mustang)" 
          transformsIfTrue:      ## we only want the mustang gt words, and not the "ford".
          - !<transforms.ConcatCombineTransform>
            separator: "-"
            transforms:
            - !<transforms.SplitTransform>
              column: "LabelName"
              separator: "-"
              index: 1
            - !<transforms.SplitTransform>
              column: "LabelName"
              separator: "-"
              index: 2
              ifMoreThan: 2
          # transformsIfFalse:
          #   value: null
      vehicle.color:
        type: "vehicle.color"
        transforms:
        - !<transforms.BooleanRegexTransform>
          column: "LabelName"
          pattern: "(?i)(blue|dark|green|light|red|white|yellow)"
          transformsIfTrue:
          - !<transforms.ColumnTransform>
            column: "LabelName"
          # transformsIfFalse:
          #   value: null
      ol.accessories:
        type: "ol.accessories"
        transforms:
        - !<transforms.BooleanRegexTransform>
          column: "LabelName"
          pattern: "(?i)(spare tire|paper-plate|pedestal-spoiler|ca-clean-air-vehicle-sticker|rectangular-sticker|uber-sticker|roof-rack|pickup-ladder-rack|racing-strip)"
          transformsIfTrue:
          - !<transforms.ColumnTransform>
            column: "LabelName"
          # transformsIfFalse:
          #   value: null
      vehicle.style:
        type: "vehicle.style"
        transforms:
        - !<transforms.BooleanRegexTransform>
          column: "LabelName"
          pattern: "(?i)(box-truck|full-size-van|other-truck|car|pickup|minivan|hatchback|sedan|SUV)"
          transformsIfTrue:
          - !<transforms.ColumnTransform>
            column: "LabelName"
          # transformsIfFalse:
          #   value: null
      ol.label:
        type: "ol.label"
        transforms:
        - !<transforms.BooleanRegexTransform>
          column: "LabelName"
          pattern: "(?i)(night|day)"
          transformsIfTrue:
          - !<transforms.ColumnTransform>
            column: "LabelName"
          # transformsIfFalse:
          #   value: null
    name: "vehiclerecords"


associationDefinitions:
  has:
    fqn: "ol.has"
    entitySetName: "NCRICHas"
    src: "vehicles"
    dst: "vehiclerecords"
    propertyDefinitions:
      ol.id:
        type: "ol.id"
        # column: "Plate"
        transforms:
        - !<transforms.ConcatTransform>
          columns: ["Plate", "red_id"]
          separator: "_"